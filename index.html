<!doctype html>
<html lang="ja">
<head>
    
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="mino0123">


    <title>mino0123.github.io - mino0123.github.io</title>
    <link rel="canonical" href="http://mino0123.github.io/">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/css/bootstrap-theme.min.css">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.1/js/bootstrap.min.js"></script>
<link href="http://mino0123.github.io/css/main.css" rel="stylesheet">
<link href='http://fonts.googleapis.com/css?family=Inconsolata:400,700' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/monokai_sublime.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

    <link href="http://mino0123.github.io/index.xml" rel="alternate" type="application/rss+xml" title="mino0123.github.io" />
</head>

<body>
<nav role="navigation" class="navbar navbar-inverse">
  <div class="container">
    <div class="navbar-header group">
        <h1 class="name">
            <a href="http://mino0123.github.io"class="navbar-brand">mino0123.github.io</a>
        </h1>
        <ul class="nav-links">
            <li class="text-link">
                <a href="http://mino0123.github.io/index.xml">
                    <i class="fa fa-rss-square fa-lg"></i>
                </a>
            </li>
            <li class="text-link">
                <a href="https://twitter.com/mino0123">
                    <i class="fa fa-twitter-square fa-lg"></i>
                </a>
            </li>
        </ul>
    </div>
  </div>
</nav>
<div class="container">
    
        <div class="well well-sm">
    <h2 class="post-title">
        <a href="http://mino0123.github.io/2016/04/19/lockerservice/">LockerServiceについての所感</a>
    </h2>
    <small class="pull-right">2016/04/19 18:43:42</small>
    <hr>
    <p><p>先日、LightningComponent上でサードパーティ製のライブラリを利用可能にするための仕組みとして、
LockerServiceがSalesforceのブログで発表された。</p>

<p><a href="https://developer.salesforce.com/blogs/developer-relations/2016/04/introducing-lockerservice-lightning-components.html">Introducing The LockerService For Lightning Components - Developer Relations</a></p>

<p><a href="http://blogjp.sforce.com/2016/04/lightning-locke-7551.html">Lightning Locker Serviceのご紹介 | Salesforce Developers Japan Blog</a></p>

<p>リリースされていないけど、今回のブログをみたのとauraのソースを少しあさった事による所感。</p>

<hr />

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">LockerServiceでReact/Angularが使えるようになると言ってるけど、aura側で検閲処理入れたラッパー(SecureVirtualDOM)を返してくるようになるとのことで、ほんとに使えるようになるんだろうかこれ？</p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/721892406640009216">2016年4月18日</a></blockquote>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">LockerServiceでReact/Angularが使えるようになると言ってるけど、aura側で検閲処理入れたラッパー(SecureVirtualDOM)を返してくるようになるとのことで、ほんとに使えるようになるんだろうかこれ？</p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/721892406640009216">2016年4月18日</a></blockquote>

<p>auraのソースで見つけたLockerServiceで使われそうな各オブジェクトのラッパー実装。</p>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="und" dir="ltr"><a href="https://github.com/forcedotcom/aura/tree/master/aura-impl/src/main/resources/aura/locker">https://github.com/forcedotcom/aura/tree/master/aura-impl/src/main/resources/aura/locker</a></p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/721892693421330436">2016年4月18日</a></blockquote>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">Elementのプロパティにもホワイトリストが<a href="https://github.com/forcedotcom/aura/blob/a76e1c04eb7be858323161bc5e9098b3706ca56c/aura-impl/src/main/resources/aura/locker/SecureElement.js#L162">https://github.com/forcedotcom/aura/blob/a76e1c04eb7be858323161bc5e9098b3706ca56c/aura-impl/src/main/resources/aura/locker/SecureElement.js#L162</a></p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/721892926322651139">2016年4月18日</a></blockquote>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">LockerService、生のオブジェクトを触る抜け道いくらでもありそうなんだけど、作ってる側はラッパーオブジェクトだけを使えるように制限することが可能でそれで安全確保できるとか考えてそうな気がちょっと</p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/722041257824923648">2016年4月18日</a></blockquote>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">そもそもwindow上掛けないしそれはないか</p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/722041848093487104">2016年4月18日</a></blockquote>

<p>Functionに文字列を渡すとコードとして実行できるが、その時にthisがグローバルオブジェクトになる。</p>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ここにFunction(&#39;return this&#39;)()があるじゃろ？</p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/722063889593081856">2016年4月18日</a></blockquote>

<p>JavaScriptではconsttuctorプロパティでオブジェクトのコンストラクタにアクセスできる。</p>

<p>コンストラクタは関数なのでFunctionのインスタンス。</p>

<p>つまり、あらゆるオブジェクトから.constructor.constructorでFunctionを取得できる。</p>

<p>単にアクセスするオブジェクトの名前でホワイトリスト作っても無駄。
<blockquote class="twitter-tweet" data-lang="ja"><p lang="en" dir="ltr">c=&#39;constructor&#39;,(1)[c]<a href="&amp;#39;return this&amp;#39;">c</a>();</p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/722217476906311680">2016年4月19日</a></blockquote></p>

<p>あと根本的な問題として、ブラウザ側は多分そんな用途を想定してない。</p>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">ブラウザ的にページ内の領域ごとにセキュリティ担保する方法を提供する方向性なんてないだろうし、仮に今raw windowへのアクセスを妨害可能だったとしても将来もそうである保証なんてないだろう</p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/722230688187977728">2016年4月19日</a></blockquote>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">彼らの言うセキュリティは多分コンポーネント実装者に悪意があっても別のパッケージのコンポーネントが持つ情報にアクセスさせたくないとかいうレベルなんだろうけど実際に提供されるものは本当に悪意があったら簡単に回避できる上に通常の開発者への負担は膨大というシロモノになりそう</p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/722232606859796480">2016年4月19日</a></blockquote>

<blockquote class="twitter-tweet" data-lang="ja"><p lang="ja" dir="ltr">でもそれが可能なのかイマイチわからない</p>&mdash; mino0123 (@mino0123) <a href="https://twitter.com/mino0123/status/722241824186695680">2016年4月19日</a></blockquote>

<p>試してみたら</p>

<pre><code class="language-js">with({window:{}, document:{}}){
  //...
}
</code></pre>

<p>の中に外部のコードを埋め込むことで一応挿げ替えはできそう。</p>

<p>と思って探したらそれっぽいことやってる部分あった。</p>

<p><a href="https://github.com/forcedotcom/aura/blob/97735919d583080a81b4d0a5734f84559a0f121c/aura-resources/src/main/resources/aura/resources/lockerservice/safeEval.html#L35">https://github.com/forcedotcom/aura/blob/97735919d583080a81b4d0a5734f84559a0f121c/aura-resources/src/main/resources/aura/resources/lockerservice/safeEval.html#L35</a></p>

<p>上記のURLを返す ConfigAdapterImpl#getLockerWorkerURL() メソッド</p>

<p><a href="https://github.com/forcedotcom/aura/blob/97735919d583080a81b4d0a5734f84559a0f121c/aura-impl/src/main/java/org/auraframework/impl/adapter/ConfigAdapterImpl.java#L455">https://github.com/forcedotcom/aura/blob/97735919d583080a81b4d0a5734f84559a0f121c/aura-impl/src/main/java/org/auraframework/impl/adapter/ConfigAdapterImpl.java#L455</a></p>

<p>このメソッドが返す値は以下のファイルでauraInitというMapにsafeEvalWorkerというキーで追加されている。</p>

<ul>
<li>aura-impl/src/main/java/org/auraframework/impl/adapter/format/html/BaseComponentDefHTMLFormatAdapter.java</li>
<li>aura-impl/src/main/java/org/auraframework/impl/adapter/format/html/BaseComponentHTMLFormatAdapter.java</li>
<li>aura/src/main/java/org/auraframework/http/resource/TemplateResource.java</li>
</ul>

<pre><code class="language-java">auraInit.put(&quot;safeEvalWorker&quot;, Aura.getConfigAdapter().getLockerWorkerURL());
</code></pre>

<p>たぶんこのマップがJSに渡るのだろう。safeEvalWorkerというキーがJSで使用されている。</p>

<p><a href="https://github.com/forcedotcom/aura/blob/97735919d583080a81b4d0a5734f84559a0f121c/aura-impl/src/main/resources/aura/Aura.js#L645">https://github.com/forcedotcom/aura/blob/97735919d583080a81b4d0a5734f84559a0f121c/aura-impl/src/main/resources/aura/Aura.js#L645</a></p>
</p>
</div>
    
        <div class="well well-sm">
    <h2 class="post-title">
        <a href="http://mino0123.github.io/2015/10/31/open_lightning_component/">Lightningコンポーネントを直接開くURL</a>
    </h2>
    <small class="pull-right">2015/10/31 23:48:39</small>
    <hr>
    <p><pre><code class="language-js">var componentName = 'MyComponent';
var hash = btoa(JSON.stringify({
  componentDef: 'one:auraContainer',
  attributes: {
    values: {
      tag: 'c:' + componentName,
      t: Date.now()
    }
  }
}));
var url = '/one/one.app#' + hash;
</code></pre>
</p>
</div>
    
        <div class="well well-sm">
    <h2 class="post-title">
        <a href="http://mino0123.github.io/2015/03/11/lightning_ignore_jserror/">LightningはJSで発生したエラーを握りつぶす</a>
    </h2>
    <small class="pull-right">2015/03/11 12:10:00</small>
    <hr>
    <p><p>理由は<a href="/2014/12/17/Lightning%E9%96%8B%E7%99%BA%E8%80%85%E3%82%AC%E3%82%A4%E3%83%89%E3%81%A7%E7%B4%B9%E4%BB%8B%E3%81%95%E3%82%8C%E3%81%A6%E3%82%8B%E3%83%AD%E3%82%B0%E5%87%BA%E5%8A%9B%E9%96%A2%E6%95%B0/">Lightning開発者ガイドで紹介されてるログ出力関数</a>で書いたのと同じ。</p>

<p>JSコントローラ内でエラーが発生すると $A.$warning$ にエラーが渡されるが</p>

<p>$A.$warning$ が $A.$logInternal$ を呼び出しているので PROD,PRODDEBUG モードだとなにも出力されない。</p>

<p>開発中にエラーを握りつぶされるためとても不便。</p>

<p>一応下記のJSで $A.$warning$ を上書きすれば見えるようになる。</p>

<pre><code class="language-js">$A.$warning$ = function (msg, err) {
	console.warn(msg, err);
};
</code></pre>
</p>
</div>
    
        <div class="well well-sm">
    <h2 class="post-title">
        <a href="http://mino0123.github.io/2015/03/10/forceclipeco/">Force.com CLI &#43; peco</a>
    </h2>
    <small class="pull-right">2015/03/10 23:00:25</small>
    <hr>
    <p><p>ふと思い立ってやってみた。</p>

<pre><code class="language-sh">force query &quot;select Id, Name from Contact where AccountId='$(force query select Id, Name from Account | peco | cut -c 2-19)'&quot;
</code></pre>

<p>pecoで選択した取引先データを親にもつ取引先責任者を表示する。</p>

<p>もっといい使い道はないだろうか。</p>
</p>
</div>
    
        <div class="well well-sm">
    <h2 class="post-title">
        <a href="http://mino0123.github.io/2014/12/17/lightning_log/">Lightning開発者ガイドで紹介されてるログ出力関数</a>
    </h2>
    <small class="pull-right">2014/12/17 00:26:51</small>
    <hr>
    <p><p><a href="https://developer.salesforce.com/docs/atlas.ja-jp.lightning.meta/lightning/debug_log_messages.htm">https://developer.salesforce.com/docs/atlas.ja-jp.lightning.meta/lightning/debug_log_messages.htm</a></p>

<blockquote>
<p>$A.log(string, [error]) メソッドを使用して、ログメッセージを JavaScript コンソールに書き出します</p>
</blockquote>

<p>とあるが、使用しても出力されなかったので調査した。</p>

<p>まずはページ内で</p>

<pre><code class="language-js">$A.log.toString()
</code></pre>

<p>を実行して関数の中身を参照。</p>

<pre><code class="language-js">function (value, error) {
  var trace;
  if(this[&quot;util&quot;].$isError$(value)) {
    error = value;
    value = error.message
  }
  if(this[&quot;util&quot;].$isError$(error)) {
    trace = this.$getStackTrace$(error)
  }else {
    if(error &amp;&amp; error.stack) {
      trace = error.stack
    }
  }
  this.$logInternal$(&quot;Info&quot;, value, error, trace)
}
</code></pre>

<p>$A.log は内部で $A.$logInternal$ を呼び出していることが分かる。
で</p>

<pre><code class="language-js">$A.$logInternal$.toString()
</code></pre>

<p>を実行して出てきたのが</p>

<pre><code class="language-js">function (type, message, error, trace) {
}
</code></pre>

<p>ということで $A.$logInternal$ には中身がなかった。</p>

<p>これは一体どういうことかとAuraのドキュメントを見ると、</p>

<p><a href="http://documentation.auraframework.org/auradocs#reference?topic=api:Aura">http://documentation.auraframework.org/auradocs#reference?topic=api:Aura</a></p>

<p>のlogメソッド(メソッドにリンクできないの不便すぎる)に</p>

<blockquote>
<p>This method doesn&rsquo;t log in PROD or PRODDEBUG modes.</p>
</blockquote>

<p>とあった。</p>

<p>Lightningコンポーネントでのモードを調べると、</p>

<p><a href="https://developer.salesforce.com/docs/atlas.ja-jp.lightning.meta/lightning/aura_debug_mode.htm">https://developer.salesforce.com/docs/atlas.ja-jp.lightning.meta/lightning/aura_debug_mode.htm</a></p>

<blockquote>
<p>デフォルトでは、Lightning コンポーネントフレームワークは PROD モードで実行されます。</p>

<p>デバッグモードを有効化すると、フレームワークはデフォルトで PRODDEBUG モードで実行されます。</p>
</blockquote>

<p>ということで、つまりLightningだとこの関数意味がない。</p>

<p>ただ「デフォルトで」というのが気になっててきとーに検索したら以下のページが見つかった。</p>

<p><a href="http://www.salesforce.com/us/developer/docs/lightning/Content/request_server_side.htm">http://www.salesforce.com/us/developer/docs/lightning/Content/request_server_side.htm</a></p>

<p>どうやら aura の方では aura.mode パラメータでモードを指定できるらしい。</p>

<p>また、どんなモードが存在するかも見つけた。</p>

<p><a href="http://www.salesforce.com/us/developer/docs/lightning/Content/modes_reference.htm">http://www.salesforce.com/us/developer/docs/lightning/Content/modes_reference.htm</a></p>

<p>実行モードには以下があるらしい。</p>

<ul>
<li>PROD</li>
<li>DEV</li>
<li>PRODDEBUG</li>
<li>JSTEST</li>
<li>JSTESTDEBUG</li>
<li>AUTOJSTEST</li>
<li>AUTOJSTESTDEBUG</li>
<li>PTEST</li>
<li>CADENCE</li>
<li>SELENIUM</li>
<li>SELENIUMDEBUG</li>
<li>UTEST</li>
<li>FTEST</li>
<li>STATS</li>
</ul>

<p>さっそくパラメータとして aura.mode=MODE_NAME の形式で各モードを指定してみたがそれでもログは出力されなかったし、
JSTESTとJSTESTDEBUGにいたっては内部サーバーエラーになった。</p>

<p>そもそもPRODDEBUG以外のモードはDEBUG付きでもJSが圧縮されていたので大体のモードはPRODと同じになってる気がする。</p>

<p>あとAuraのドキュメントでも関数の説明が</p>

<blockquote>
<p>Logs to the browser&rsquo;s JavaScript console if it is available.</p>
</blockquote>

<p>としかないので、jsのコンソールに出力するだけならばそもそもこの関数の存在する理由が分からない。</p>

<p>最終的にはモードを切り替えが可能になると共に出力有無を切り替えできるようになるんだろうか。</p>
</p>
</div>
    
        <div class="well well-sm">
    <h2 class="post-title">
        <a href="http://mino0123.github.io/2014/12/14/lightningappbuilder/">Lightning App Builder</a>
    </h2>
    <small class="pull-right">2014/12/14 06:00:00</small>
    <hr>
    <p>

<p><a href="http://qiita.com/advent-calendar/2014/salesforce1">Salesforce1 Advent Calendar</a>
14日目の記事です。</p>

<p>Lightning App Builder についてデモ動画、</p>

<p><a href="https://www.youtube.com/watch?v=f9HvfbNh70M&amp;list=UUEWplP9qrhNjXVggK5W5CvA">Salesforce World Tour Tokyo(2014年12月) - ～IoTと次世代モバイルアプリの最新事例紹介～アプリの開発スピードを革新するSalesforce1 Lightning～</a></p>

<p>から得られる情報をまとめます。</p>

<p>ちなみにまだデモで存在するだけなため、リリースまでにいろいろ変更される可能性があります。</p>

<!--
[developer.salesforce.com/lightning](https://developer.salesforce.com/lightning)
-->

<p>まずは App Builder に入る前のビューですが、</p>

<p><a href="/img/2014/12/14/FlexiPageList.png" target="_blank">
    <img src="/img/2014/12/14/FlexiPageList.png" style="width:100%;max-width:800px;">
</a></p>

<pre><code>ビジュアルアプリケーションビルダーには、Flexible Pagesを使用してSalesforce1 のカスタムアプリケーションページを作成するための使いやすいグラフィカルインターフェースが用意されています。
</code></pre>

<p>と書かれています。</p>

<p>要するにLightning App Builder は Flexible Page をGUIで作成できるもの、ということでしょう。</p>

<!-- ビューのURLは https://ap1.salesforce.com/_ui/flexipage/ui/FlexiPageListUi/d -->

<p><a href="/img/2014/12/14/LightningAppBuilder01.png" target="_blank">
    <img src="/img/2014/12/14/LightningAppBuilder01.png" style="width:100%;max-width:800px;">
</a></p>

<p>新規ボタンを押した後に立ち上がる App Builder の画面です。</p>

<p>作成する画面の種別を3種類から選ぶようです。</p>

<p>これによって作成したページを割り当てできる箇所が変わるのでしょう。</p>

<p>翻訳後のレイアウト調整がまだなのか少しページが崩れていますが、本リリースまでには直ることでしょう多分。</p>

<p>ページ種別を選択するとページのテンプレートの選択に移行します。</p>

<ul>
<li>テンプレートA(1領域)</li>
</ul>

<p><a href="/img/2014/12/14/LightningAppBuilder02.png" target="_blank">
    <img src="/img/2014/12/14/LightningAppBuilder02.png" style="width:100%;max-width:800px;">
</a></p>

<ul>
<li>テンプレートB(2領域)</li>
</ul>

<p><a href="/img/2014/12/14/LightningAppBuilder03.png" target="_blank">
    <img src="/img/2014/12/14/LightningAppBuilder03.png" style="width:100%;max-width:800px;">
</a></p>

<ul>
<li>テンプレートC(3領域)</li>
</ul>

<p><a href="/img/2014/12/14/LightningAppBuilder04.png" target="_blank">
    <img src="/img/2014/12/14/LightningAppBuilder04.png" style="width:100%;max-width:800px;">
</a></p>

<p>まとめると、最大3つのエリアをもつページを作成することができ、</p>

<p>各エリアはページを参照する端末によって表示される箇所が変わる、ということのようです。</p>

<p>下に「AppExchange上でテンプレートを探す」というリンクがありますので
もしかするとこれ以外のレイアウトもテンプレートとして作成・公開できるようになるのでしょうか。</p>

<p>テンプレートを選択すると最後にページの名前を設定してドラッグ&amp;ドロップによるページ作成が始まります。</p>

<p><a href="/img/2014/12/14/LightningAppBuilder05.png" target="_blank">
    <img src="/img/2014/12/14/LightningAppBuilder05.png" style="width:100%;max-width:800px;">
</a></p>

<p>[標準コンポーネント], [カスタムコンポーネント] の下に [AppExchangeコンポーネント] が並んでいるのが分かります。</p>

<p>いままでは ユーザがD&amp;Dで設定できてAppExchangeで公開できるUIはVisualforceページのみだった
(カスタムコンポーネントでコンポーネント単位の公開はできるけど使用するのにコーディングが必要)
のが、コンポーネント単位で公開しそこからユーザがD&amp;Dでページに組み込むことができるようになるようです。</p>

<p>ページの設定の一番下に[処理]とありますが、Lightning Process Builderで作成した処理を割り当てたりできるのでしょうか。</p>

<p><a href="/img/2014/12/14/LightningAppBuilder06.png" target="_blank">
    <img src="/img/2014/12/14/LightningAppBuilder06.png" style="width:100%;max-width:800px;">
</a></p>

<p><a href="/img/2014/12/14/LightningAppBuilder09.png" target="_blank">
    <img src="/img/2014/12/14/LightningAppBuilder09.png" style="width:100%;max-width:800px;">
</a></p>

<p>プレビューの端末を変更することもできます。</p>

<p><a href="/img/2014/12/14/LightningAppBuilder10.png" target="_blank">
    <img src="/img/2014/12/14/LightningAppBuilder10.png" style="width:100%;max-width:800px;">
</a></p>

<h3 id="まとめ:efbb8997069fcf1a0878ff17f0598ba5">まとめ</h3>

<p>いままでの Salesforce は AppExchange で公開されたものをコーディングなしで自組織に組み込むことのできるUIとしてはVisualforceページが最小単位だったと思いますが、テンプレートやコンポーネントなど、より小さな単位でAppExchangeで公開可能にすることを目指しているようです。</p>
</p>
</div>
    
        <div class="well well-sm">
    <h2 class="post-title">
        <a href="http://mino0123.github.io/2014/12/07/new_blog/">ブログを新しくした</a>
    </h2>
    <small class="pull-right">2014/12/07 04:00:00</small>
    <hr>
    <p>

<p>golang製の静的サイトジェネレータである <a href="http://gohugo.io/">Hugo</a> を使った。</p>

<p><a href="http://github.com/spf13/hugo/tree/master/examples/blog">examples/blog</a>
 がそのまま動いたのでうまくいくかと思いきや、そこそこ面倒くさかった。</p>

<ul>
<li><p>configでパーマリンクを指定したとき、日本語が含まれていると生成されるファイルだけパーセントエンコードされリンクが切れる。</p></li>

<li><p>それを直そうとcloneしてきたら path.Join 使ってたところがすべて filepath.Join になっててWindowsだとファイル区切りが\になってた。</p></li>
</ul>

<p>そもそも url と生成時のファイル生成のパスの扱いが同じ関数で行われている。</p>

<p>結局、</p>

<ul>
<li>hugolib/permalinks.go 内 pageToPermalinkFilename で Urlize を止める。</li>
<li>helpers/url.go の filepath を path にもどす。</li>
</ul>

<p>という修正をやって動かしてる。</p>

<p>後者に関してはissueは挙がってたしそのうち直るだろうたぶん。</p>

<ul>
<li><a href="https://github.com/spf13/hugo/issues/604">#604 Wrong directory generated for newly created content on Windows</a></li>
<li><a href="https://github.com/spf13/hugo/issues/660">#660 Failing unit tests on windows due forward slash vs back slash</a></li>
<li><a href="https://github.com/spf13/hugo/issues/687">#687 MakePermalink generate backslash on Windows</a></li>
</ul>

<p>あとコードのハイライトは pygments 使おうと思ったけどなぜかpタグがcode内にでてくる
<p>function func() {
    var v;
    v = 0;
    v = ‘string’;
    v = function () {};
}</p>

ので Hilight.js の monokai sublime テーマにした。</p>

<pre><code class="language-js">function func() {
    var v;
    v = 0;
    v = 'string';
    v = function () {};
}
</code></pre>

<h3 id="追記:f56fb4c3ce511076d3f0c4a9fc83b8a1">追記</h3>

<p>静的ファイルの追加が何故か1フォルダしか行われていなかった。
chtimeで権限エラーになっていた。
hugo.go で NewSyncer 後に</p>

<pre><code class="language-go">syncer.NoTimes = true
</code></pre>

<p>を追加することで最終更新日の同期をやめさせて対応した。</p>

<pre><code class="language-patch">diff --git a/commands/hugo.go b/commands/hugo.go
index 6fd7fa2..21dad47 100644
--- a/commands/hugo.go
+++ b/commands/hugo.go
@@ -227,6 +229,7 @@ func copyStatic() error {
    publishDir := helpers.AbsPathify(viper.GetString(&quot;PublishDir&quot;)) + &quot;/&quot;
 
    syncer := fsync.NewSyncer()
+   syncer.NoTimes = true
    syncer.NoTimes = viper.GetBool(&quot;notimes&quot;)
    syncer.SrcFs = hugofs.SourceFs
    syncer.DestFs = hugofs.DestinationFS
diff --git a/helpers/url.go b/helpers/url.go
index dd8d750..6b234b4 100644
--- a/helpers/url.go
+++ b/helpers/url.go
@@ -16,7 +16,7 @@ package helpers
 import (
    &quot;fmt&quot;
    &quot;net/url&quot;
-   &quot;path/filepath&quot;
+   &quot;path&quot;
    &quot;strings&quot;
 
    &quot;github.com/PuerkitoBio/purell&quot;
@@ -68,7 +68,7 @@ func MakePermalink(host, plink string) *url.URL {
        panic(fmt.Errorf(&quot;Can't make permalink from absolute link %q&quot;, plink))
    }
 
-   base.Path = filepath.Join(base.Path, p.Path)
+   base.Path = path.Join(base.Path, p.Path)
 
    // path.Join will strip off the last /, so put it back if it was there.
    if strings.HasSuffix(p.Path, &quot;/&quot;) &amp;&amp; !strings.HasSuffix(base.Path, &quot;/&quot;) {
@@ -84,7 +84,7 @@ func UrlPrep(ugly bool, in string) string {
        return x
    } else {
        x := PrettifyUrl(SanitizeUrl(in))
-       if filepath.Ext(x) == &quot;.xml&quot; {
+       if path.Ext(x) == &quot;.xml&quot; {
            return x
        }
        url, err := purell.NormalizeURLString(x, purell.FlagAddTrailingSlash)
@@ -100,8 +100,8 @@ func UrlPrep(ugly bool, in string) string {
 func PrettifyUrl(in string) string {
    x := PrettifyPath(in)
 
-   if filepath.Base(x) == &quot;index.html&quot; {
-       return filepath.Dir(x)
+   if path.Base(x) == &quot;index.html&quot; {
+       return path.Dir(x)
    }
 
    if in == &quot;&quot; {
@@ -115,17 +115,17 @@ func PrettifyUrl(in string) string {
 // /section/name/  -&gt; /section/name.html
 // /section/name.html -&gt; /section/name.html
 func Uglify(in string) string {
-   if filepath.Ext(in) == &quot;&quot; {
+   if path.Ext(in) == &quot;&quot; {
        if len(in) &lt; 2 {
            return &quot;/&quot;
        }
        // /section/name/  -&gt; /section/name.html
-       return filepath.Clean(in) + &quot;.html&quot;
+       return path.Clean(in) + &quot;.html&quot;
    } else {
        name, ext := FileAndExt(in)
        if name == &quot;index&quot; {
            // /section/name/index.html -&gt; /section/name.html
-           d := filepath.Dir(in)
+           d := path.Dir(in)
            if len(d) &gt; 1 {
                return d + ext
            } else {
@@ -133,7 +133,7 @@ func Uglify(in string) string {
            }
        } else {
            // /section/name.html -&gt; /section/name.html
-           return filepath.Clean(in)
+           return path.Clean(in)
        }
    }
 }
diff --git a/hugolib/permalinks.go b/hugolib/permalinks.go
index 642de83..955401c 100644
--- a/hugolib/permalinks.go
+++ b/hugolib/permalinks.go
@@ -146,7 +146,8 @@ func pageToPermalinkTitle(p *Page, _ string) (string, error) {
 func pageToPermalinkFilename(p *Page, _ string) (string, error) {
    //var extension = p.Source.Ext
    //var name = p.Source.Path()[0 : len(p.Source.Path())-len(extension)]
-   return helpers.Urlize(p.Source.BaseFileName()), nil
+   return p.Source.BaseFileName(), nil
+   // return helpers.Urlize(p.Source.BaseFileName()), nil
 }
 
 // if the page has a slug, return the slug, else return the title
</code></pre>
</p>
</div>
    
        <footer>
            <div class="row">
                <hr>
                <div class="col-sm-12">
                    <small class="pull-right">
                    Built with <a href="http://gohugo.io/">Hugo</a>
                    </small>
                </div>
            </div>
        </footer>
</div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-57414013-1', 'auto');
  ga('send', 'pageview');
</script>
</body>
</html>
